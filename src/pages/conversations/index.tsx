import React from "react";

import { GetServerSideProps, NextPage } from "next";
import Head from "next/head";

import { MainLayout } from "@/layouts/MainLayout";

import { PageTitle } from "@/components/ui/PageTitle";
import { SearchInput } from "@/components/SearchInput";
import { ConversationItem } from "@/components/ConversationItem";
import { Line } from "@/components/ui/Line";

import { IConversation } from "@/api/types";
import { Api } from "@/api/index";

import styles from "./Conversations.module.scss";
import { socket } from "@/utils/SocketContext";

interface ConversationsProps {
  conversations: IConversation[];
}

const Conversations: NextPage<ConversationsProps> = ({ conversations }) => {
  const [searchText, setSearchText] = React.useState("");
  const [localConversations, setLocalConversations] =
    React.useState<IConversation[]>(conversations);

  React.useEffect(() => {
    (async () => {
      try {
        socket.on("onMessage", async (payload) => {
          const { ...message } = payload;

          const data = await Api().conversation.getAll();

          setLocalConversations(data);
        });
      } catch (err) {
        console.warn(err);
      }
    })();

    return () => {
      socket.off("onMessage");
      socket.off("onDeleteMessage");
      socket.off("message");
    };
  }, [socket]);

  return (
    <MainLayout fullWidth>
      <Head>
        <title>Сообщения</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicons/favicon.ico" />
      </Head>
      <main className={styles.container}>
        <PageTitle pageTitle="Сообщения" />
        <SearchInput handleChange={(text) => setSearchText(text)} width={600} />
        <div className={styles.conversationsBlock}>
          {localConversations?.map((obj) => (
            <React.Fragment key={obj.conversationId}>
              <ConversationItem {...obj} />
              {obj.conversationId !==
                localConversations[localConversations.length - 1]
                  ?.conversationId && <Line />}
            </React.Fragment>
          ))}
        </div>
      </main>
    </MainLayout>
  );
};

export default Conversations;

export const getServerSideProps: GetServerSideProps = async (ctx) => {
  if (!ctx.req.cookies.authToken) {
    return {
      redirect: {
        destination: "/",
        permanent: false,
      },
    };
  }
  const data = await Api(ctx).conversation.getAll();

  return {
    props: { conversations: data },
  };
};
